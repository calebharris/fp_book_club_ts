<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chapter 5. Strictness and laziness | Functional Programming in TypeScript</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/fp_book_club_ts/assets/css/0.styles.fa19ed37.css" as="style"><link rel="preload" href="/fp_book_club_ts/assets/js/app.9c1fe345.js" as="script"><link rel="preload" href="/fp_book_club_ts/assets/js/8.ac5b33ff.js" as="script"><link rel="prefetch" href="/fp_book_club_ts/assets/js/2.30eef2e3.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/3.121f6e20.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/4.9c6222f2.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/5.07927b69.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/6.1e8e7f40.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/7.1e49933b.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/9.88fcb229.js">
    <link rel="stylesheet" href="/fp_book_club_ts/assets/css/0.styles.fa19ed37.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fp_book_club_ts/" class="home-link router-link-active"><!----> <span class="site-name">Functional Programming in TypeScript</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fp_book_club_ts/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Chapters</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_1.html" class="nav-link">Chapter 1</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_2.html" class="nav-link">Chapter 2</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_3.html" class="nav-link">Chapter 3</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_4.html" class="nav-link">Chapter 4</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_5.html" class="nav-link router-link-exact-active router-link-active">Chapter 5</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/calebharris/fp_book_club_ts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fp_book_club_ts/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Chapters</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_1.html" class="nav-link">Chapter 1</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_2.html" class="nav-link">Chapter 2</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_3.html" class="nav-link">Chapter 3</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_4.html" class="nav-link">Chapter 4</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_5.html" class="nav-link router-link-exact-active router-link-active">Chapter 5</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/calebharris/fp_book_club_ts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fp_book_club_ts/chapter_1.html" class="sidebar-link">Chapter 1. What is functional programming?</a></li><li><a href="/fp_book_club_ts/chapter_2.html" class="sidebar-link">Chapter 2. Getting started with functional programming in TypeScript</a></li><li><a href="/fp_book_club_ts/chapter_3.html" class="sidebar-link">Chapter 3. Functional data structures</a></li><li><a href="/fp_book_club_ts/chapter_4.html" class="sidebar-link">Chapter 4. Handling errors without exceptions</a></li><li><a href="/fp_book_club_ts/chapter_5.html" class="active sidebar-link">Chapter 5. Strictness and laziness</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#strict-and-non-strict-functions" class="sidebar-link">Strict and non-strict functions</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#an-extended-example-lazy-lists" class="sidebar-link">An extended example: lazy lists</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#memoizing-streams-and-avoiding-recomputation" class="sidebar-link">Memoizing streams and avoiding recomputation</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#helper-functions-for-inspecting-streams" class="sidebar-link">Helper functions for inspecting streams</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-1-tolist" class="sidebar-link">Exercise 5.1. toList</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-2-take-and-drop" class="sidebar-link">Exercise 5.2. take and drop</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-3-takewhile" class="sidebar-link">Exercise 5.3. takeWhile</a></li></ul></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#separating-program-description-from-execution" class="sidebar-link">Separating program description from execution</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-4-forall" class="sidebar-link">Exercise 5.4. forAll</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-5-takewhile-using-foldright" class="sidebar-link">Exercise 5.5. takeWhile using foldRight</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-6-headoption-using-foldright" class="sidebar-link">Exercise 5.6. headOption using foldRight</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-7-additional-stream-functions" class="sidebar-link">Exercise 5.7. Additional Stream functions</a></li></ul></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#infinite-streams-and-corecursion" class="sidebar-link">Infinite streams and corecursion</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-8-constant" class="sidebar-link">Exercise 5.8. constant</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-9-from" class="sidebar-link">Exercise 5.9. from</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-10-fibs" class="sidebar-link">Exercise 5.10. fibs</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_5.html#exercise-5-11-unfold" class="sidebar-link">Exercise 5.11. unfold</a></li></ul></li></ul></li></ul> </div> <div class="page"> <div class="content"><h1 id="chapter-5-strictness-and-laziness"><a href="#chapter-5-strictness-and-laziness" aria-hidden="true" class="header-anchor">#</a> Chapter 5. Strictness and laziness</h1> <p>Recall <code>List</code> operations from <a href="/fp_book_club_ts/chapter_3.html">Chapter 3</a>: <code>map</code>, <code>filter</code>, <code>foldLeft</code>, <code>foldRight</code>, <code>zipWith</code>, etc.
Each one passes over the whole input list and outputs a freshly-created list. For example, each transformation in the
following code produces a new list, and each of these lists (except the last one) is discarded almost immediately after
being created.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token operator">&gt;</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token function">List</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">Note</p> <p>&quot;Whoa, wait a minute,&quot; you might be thinking. &quot;Our <code>List</code> commands did not look like this, and did not produce nice,
clean console output like this.&quot; That's true, because we wrote all our <code>List</code> functions at the top level of the module,
rather than defining them on a parent class like we did for <code>Option</code> and <code>Either</code>. We're going to use <code>List</code> a lot, so
as an exercise, you might want to go back and update the code to enable the more object-oriented syntax. Hint: You can
do this without deleting any of the existing <code>List</code> functions!</p> <p>The nice output comes from the <a href="https://nodejs.org/dist/latest-v10.x/docs/api/util.html#util_custom_inspection_functions_on_objects" title="Util | Node.js Documentaiton" target="_blank" rel="noopener noreferrer">custom inspection function<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> capability supported by Node. Check out the
<code>List</code> source in the online repository for details.</p></div> <p>We'd like to fuse these operations together into a single pass and avoid creating the intermediate temporary data
structures. We could accomplish this by writing a one-off <code>while</code> loop, but that wouldn't be reusable. It would be
better if we could have this done automatically while retaining the same high-level, composable style we've been
developing.</p> <p>We can achieve this automatic loop fusion through the use of <em>non-strictness</em>, also called <em>laziness</em>. In this chapter,
we'll work through the construction of a lazy list type that fuses transformations, and see how non-strictness is a
fundamental technique for writing more efficient and modular functional programs in general.</p> <h2 id="strict-and-non-strict-functions"><a href="#strict-and-non-strict-functions" aria-hidden="true" class="header-anchor">#</a> Strict and non-strict functions</h2> <p>Non-strictness is a property of a function that means the function may choose not to evaluate some or all of its
arguments. Strict functions, as you may guess, always evaluate their arguments. Although you may not have heard about
function strictness, you are probably already familiar with the behavior. In certain cases, we call it
<em>short-circuiting</em>. Many languages, including TypeScript, have the short-circuiting boolean operators <code>&amp;&amp;</code> and <code>||</code>. The
operator <code>&amp;&amp;</code> only evaluates its second argument if its first is <code>true</code>, while <code>||</code> only evaluates its second argument
if its first is <code>false</code>.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token operator">&gt;</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hey!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// doesn't print anything</span>
<span class="token boolean">false</span>

<span class="token operator">&gt;</span> <span class="token boolean">true</span> <span class="token operator">||</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hey!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// doesn't print anything, either</span>
<span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>The <code>if-else</code> construct in TypeScript is also non-strict. The <code>else</code> block is only evaluated when the condition in the
<code>if</code> block is false, and the <code>if</code> block only when the condition is true.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token operator">&gt;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Goodbye&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Hello
undefined
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>More precisely, <code>if</code> is strict in its condition parameter, since it always evaluates the condition in order to know
which branch to execute, and non-strict in its two branches.</p> <p>TypeScript lacks explicit support for writing functions with non-strict parameters. However, there is a simple
work-around. Consider the following non-strict <code>if</code> function:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> if2 <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>cond<span class="token punctuation">:</span>    <span class="token builtin">boolean</span><span class="token punctuation">,</span>
                onTrue<span class="token punctuation">:</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">A</span><span class="token punctuation">,</span>
                onFalse<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">A</span> <span class="token operator">=&gt;</span>
  cond <span class="token operator">?</span> <span class="token function">onTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">onFalse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Our <code>if2</code> function takes three arguments, just like a standard <code>if</code> expression: a condition, what to do if the condition
is true, and what to do if the condition is false. Notice the type of the branch arguments: <code>() =&gt; A</code>. In other words,
they are functions that take zero arguments and return a value. Recall from <a href="/fp_book_club_ts/chapter_4.html#_4-thunks">Chapter 4</a> that
another name for this type of function is a <em>thunk</em> and that one of the uses of a thunk is to allow for lazy evaluation.
Oh, we just solved the problem! When <code>if2</code> is called, technically all its arguments will be evaluated immediately. It
just so happens that two of those arguments evaluate to anonymous functions, only one of which will be eventually
executed. We sometimes call executing a thunk <em>forcing</em> the thunk.</p> <p>One small problem with our solution is that we now have to execute a function, which potentially uses significant
resources to compute, any time we want to use our non-strict parameter.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token operator">&gt;</span> <span class="token keyword">const</span> maybeTwice <span class="token operator">=</span> <span class="token punctuation">(</span>b<span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> i<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> b <span class="token operator">?</span> <span class="token function">i</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">i</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> <span class="token function">maybeTwice</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">41</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hi
hi
<span class="token number">84</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>We could cache the result of the thunk in a variable the first time we use it, but that can become unwieldy in
situations with multiple branches. It would be better if we had a way to automatically cache the result when the thunk
is first executed and return the cached value for subsequent invocations. This technique is called <em>memoization</em>, and we
can add a small function to our <code>util</code> module to help us do it.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> memoize <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">A</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// in strict mode, TypeScript will not allow variables to be `null`</span>
  <span class="token comment">// unless explicitly allowed in the type annotation</span>
  <span class="token keyword">let</span> memo<span class="token punctuation">:</span> <span class="token constant">A</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>memo <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      memo <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Now if we refactor <code>maybeTwice</code> to use <code>memoize</code>, we can see that it only executes the thunk once.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token operator">&gt;</span> <span class="token keyword">import</span> util <span class="token keyword">from</span> <span class="token string">&quot;./fpbookclub/getting_started/util&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token operator">&gt;</span> <span class="token keyword">const</span> maybeTwice <span class="token operator">=</span> <span class="token punctuation">(</span>b<span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> i<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">...</span> <span class="token keyword">const</span> i2 <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">memoize</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span> <span class="token keyword">return</span> b <span class="token operator">?</span> <span class="token function">i2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">i2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">...</span> <span class="token punctuation">}</span>
undefined
<span class="token operator">&gt;</span> <span class="token function">maybeTwice</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">41</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
hi
<span class="token number">84</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">Formal definition of strictness</p> <p>If the evaluation of an expression runs forever or throws an error instead of returning a definite value, we say that
the expression doesnâ€™t <em>terminate</em>, or that it evaluates to <em>bottom</em>. A function <code>f</code> is strict if the expression <code>f(x)</code>
evaluates to bottom for all <code>x</code> that evaluate to bottom.</p></div> <p>One more piece of terminology: we can say that a function takes its non-strict arguments <em>by name</em>, rather than <em>by
reference</em> or <em>by value</em>.</p> <h2 id="an-extended-example-lazy-lists"><a href="#an-extended-example-lazy-lists" aria-hidden="true" class="header-anchor">#</a> An extended example: lazy lists</h2> <p>Back to the problem at hand (remember that?). How can we construct a list-like data type that uses laziness and
non-strictness to help us improve the modularity and efficiency of our functional programs? Below is a listing for a
simple <em>lazy list</em>, or <em>stream</em> type. It should look very similar to the <code>List</code> type from
<a href="/fp_book_club_ts/chapter_3.html#defining-functional-data-structures">Chapter 3</a> (especially if you've gone back and done the refactoring
suggested above), but with a few notable differences.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> util <span class="token keyword">from</span> <span class="token string">&quot;../getting_started/util&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * A `Stream` element is either an `Empty` or a `Cons`, analagous to the `Nil`
 * and `Cons` data constructors of `List`.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> Empty<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">|</span> Cons<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Base trait for `Stream` data constructors
 */</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">StreamBase</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">/**
 * `Empty` data constructor, which creates the singleton `Empty` value that
 * we'll always use.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Empty</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">StreamBase</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> readonly <span class="token constant">EMPTY</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span>never<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  readonly tag<span class="token punctuation">:</span> <span class="token string">&quot;empty&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;empty&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * A nonempty stream consists of a head and a tail, both of which are
 * non-strict
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">StreamBase</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  readonly tag<span class="token punctuation">:</span> <span class="token string">&quot;cons&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;cons&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>readonly h<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">A</span><span class="token punctuation">,</span> readonly t<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Smart constructor for creating a nonempty Stream
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> cons <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span> <span class="token operator">&gt;</span><span class="token punctuation">(</span>hd<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">A</span><span class="token punctuation">,</span> tl<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span>
  <span class="token comment">// We cache the head and tail using `memoize` to avoid repeated evaluation</span>
  <span class="token keyword">new</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">memoize</span><span class="token punctuation">(</span>hd<span class="token punctuation">)</span><span class="token punctuation">,</span> util<span class="token punctuation">.</span><span class="token function">memoize</span><span class="token punctuation">(</span>tl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Smart constructor for creating an empty Stream of a particular type
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> empty <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> Empty<span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Convenience method for constructing a Stream from multiple elements
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Stream <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">...</span>aa<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>aa<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token function">cons</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> aa<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token operator">...</span>aa<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> Cons<span class="token punctuation">,</span> Empty<span class="token punctuation">,</span> Stream<span class="token punctuation">,</span> cons<span class="token punctuation">,</span> empty <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>The main difference from <code>List</code> is that the <code>Cons</code> data constructor takes thunks for the <code>head</code> and <code>tail</code> parameters,
instead of regular strict values. If we want to use the head or traverse the stream, we need to explicity force the
thunks, just like we did in our revised <code>if2</code> function. For example, here's a method that optionally extracts the head
of a <code>Stream</code> (in case it isn't clear, this should be defined on the <code>StreamBase</code> class):</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">headOption</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;empty&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">some</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Other than forcing the head thunk, this works pretty much the same way the <code>List</code> version does. This ability of a
<code>Stream</code> to evaluate only the portion of itself needed in the moment is key to enabling composable, yet efficient, code.</p> <h3 id="memoizing-streams-and-avoiding-recomputation"><a href="#memoizing-streams-and-avoiding-recomputation" aria-hidden="true" class="header-anchor">#</a> Memoizing streams and avoiding recomputation</h3> <p>Typically, we want to cache the value of a <code>Cons</code> node, once it has been forced. But if we use the <code>Cons</code> data
constructor directly, this code will compute <code>expensive</code> twice:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">expensive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> h1 <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">headOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> h2 <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">headOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>We get around this problem by using smart constructors, which we first encountered in
<a href="/fp_book_club_ts/chapter_4.html#_10-smart-constructors">Chapter 4</a>. Smart constructors can construct data types while enforcing some
additional invariants or providing slightly different signatures than the &quot;real&quot; constructors used for pattern matching.
Our <code>cons</code> smart constructor takes care of memoizing the non-strict arguments for the head and tail of the <code>Cons</code>,
ensuring that the thunks do their work only the first time they are forced.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> cons <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span> <span class="token operator">&gt;</span><span class="token punctuation">(</span>hd<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">A</span><span class="token punctuation">,</span> tl<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span>
  <span class="token keyword">new</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">memoize</span><span class="token punctuation">(</span>hd<span class="token punctuation">)</span><span class="token punctuation">,</span> util<span class="token punctuation">.</span><span class="token function">memoize</span><span class="token punctuation">(</span>tl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Our <code>empty</code> smart constructor just returns the <code>Empty.EMPTY</code> singleton value, but is annotated with <code>Stream&lt;A&gt;</code>, which
helps the TypeScript compiler perform better type inferencing in some cases. When dealing with ADTs, we almost always
want to infer the base type. Defining smart constructors that return the base type is a common trick.</p> <h3 id="helper-functions-for-inspecting-streams"><a href="#helper-functions-for-inspecting-streams" aria-hidden="true" class="header-anchor">#</a> Helper functions for inspecting streams</h3> <p>Let's start by writing a few functions to help us inspect what's inside our <code>Stream</code>s, which will make later exercises
easier.</p> <h3 id="exercise-5-1-tolist"><a href="#exercise-5-1-tolist" aria-hidden="true" class="header-anchor">#</a> Exercise 5.1. <code>toList</code></h3> <p>Write a function that converts a <code>Stream</code> to a <code>List</code>, which will force its evaluation and let you look at it in the
REPL. Place this and other functions inside the <code>StreamBase</code> class.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><details><summary>Answer</summary> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">toList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;empty&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">cons</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></details> <h3 id="exercise-5-2-take-and-drop"><a href="#exercise-5-2-take-and-drop" aria-hidden="true" class="header-anchor">#</a> Exercise 5.2. <code>take</code> and <code>drop</code></h3> <p>Write the function <code>take(n)</code>, which returns the first <code>n</code> elements of a <code>Stream</code>; and <code>drop(n)</code>, which skips the first
<code>n</code> elements of a <code>Stream</code>.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">take</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span>

<span class="token function">drop</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="exercise-5-3-takewhile"><a href="#exercise-5-3-takewhile" aria-hidden="true" class="header-anchor">#</a> Exercise 5.3. <code>takeWhile</code></h3> <p>Write a function <code>takeWhile</code> for returning the longest prefix of a <code>Stream</code> whose elements match the provided predicate.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">takeWhile</span><span class="token punctuation">(</span>p<span class="token punctuation">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>You can use these functions together to inspect streams in the REPL. For example, try</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token operator">&gt;</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="separating-program-description-from-execution"><a href="#separating-program-description-from-execution" aria-hidden="true" class="header-anchor">#</a> Separating program description from execution</h2> <p><em>Separation of concerns</em> is a phrase you've probably heard â€” it's a major theme in just about every subdiscipline
of software engineering. Functional programming is particularly concerned with separating the description of
computations from the act of running them. <code>Option</code> and <code>Either</code>, at there cores, are ways of describing that a
computation can result in an error, or more than one type of value. <code>Stream</code> lets us describe a computation that emits a
sequence of results, but doesn't compute any individual result until it's needed.</p> <p>This is the power of laziness in general: we can describe a much larger computation than we need and then choose to
evaluate only parts of it. An example is the <code>exists</code> function for <code>Stream</code>:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// necessary to work around a quirk of Typescript's type inferencing</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">p</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> self<span class="token punctuation">.</span><span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Recall from earlier that <code>||</code> is a short-circuiting operator. In other words, it's non-strict in its second argument. So
if <code>p(self.h())</code> is true, then <code>self.t()</code> is never evaluated. Not only does the traversal terminate early, but the
remainder of the <code>Stream</code> is never actually computed!</p> <p>The version of <code>exists</code> above uses explicit recursion. But, just like with we did in
<a href="/fp_book_club_ts/chapter_3.html#recursion-over-lists-and-generalizing-to-higher-order-functions">Chapter 3</a> with <code>List</code>, we can define
general-purpose recursion utilities for <code>Stream</code> and implement other functions on top of those utilities.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code>foldRight<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">B</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">B</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">B</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> self<span class="token punctuation">.</span><span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foldRight</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Above is a lazy version of <code>foldRight</code>, which is non-strict in its first (a.k.a. &quot;zero&quot;) argument, and takes a combiner
function that is non-strict in its second argument. This means that <code>f</code> can choose not to execute the thunk for its
second argument. If it does so, then the recursion terminates early. Implementing <code>exists</code> in terms of <code>foldRight</code>
illustrates this:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">foldRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Here <code>b</code> is a thunk that, when evaluated, generates the tail of the <code>Stream</code>. If <code>p(a)</code> returns true, the thunk is never
called and the computation terminates without building the rest of the <code>Stream</code>. Remember that with the strict version
of <code>foldRight</code> in <code>List</code>, we couldn't do that.</p> <h3 id="exercise-5-4-forall"><a href="#exercise-5-4-forall" aria-hidden="true" class="header-anchor">#</a> Exercise 5.4. <code>forAll</code></h3> <p>Implement <code>forAll</code>, which checks that all elements in the <code>Stream</code> match a given predicate. It should terminate the
traversal as soon as it finds a nonmatching element.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">forAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="exercise-5-5-takewhile-using-foldright"><a href="#exercise-5-5-takewhile-using-foldright" aria-hidden="true" class="header-anchor">#</a> Exercise 5.5. <code>takeWhile</code> using <code>foldRight</code></h3> <p>Refactor <code>takeWhile</code> to use <code>foldRight</code>.</p> <h3 id="exercise-5-6-headoption-using-foldright"><a href="#exercise-5-6-headoption-using-foldright" aria-hidden="true" class="header-anchor">#</a> Exercise 5.6. <code>headOption</code> using <code>foldRight</code></h3> <p>Refactor <code>headOption</code> to use <code>foldRight</code>.</p> <h3 id="exercise-5-7-additional-stream-functions"><a href="#exercise-5-7-additional-stream-functions" aria-hidden="true" class="header-anchor">#</a> Exercise 5.7. Additional <code>Stream</code> functions</h3> <p>Implement <code>map</code>, <code>filter</code>, <code>append</code>, and <code>flatMap</code> using <code>foldRight</code>. The <code>append</code> method should be non-strict in its
argument.</p> <p>Because they use the lazy <code>foldRight</code>, these implementations are <em>incremental</em>. They do just enough work to provide only
the elements requested by larger computations composed of these functions. That means we can chain them together without
fully instantiating the intermediate results, as is the case with <code>List</code>.</p> <p>Let's rewrite part of the motivating example for this chapter using <code>Stream</code>, instead of <code>List</code>.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token operator">&gt;</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">List</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>What would a trace for this program look like, using the substitution model? An attempt to represent such a trace is
made below, but due to the many thunks involved, it may be hard to read. It's worth trying to do this on your own, with
pen and paper, unbound by the confines of Web typography. Although <code>map</code> and <code>filter</code> are defined in terms of
<code>foldRight</code>, we've chosen to treat them as if they used explicit recursion in this trace, to make it easier to follow.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// substitute result of `Stream` function</span>
<span class="token function">cons</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// `map` forces the first element, transforms it, and wraps the tail</span>
<span class="token comment">// in a recursive call</span>
<span class="token function">cons</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// `filter` forces the new, mapped first element, and then discards it,</span>
<span class="token comment">// because it doesn't pass the predicate. In this case, `filter`</span>
<span class="token comment">// evaluates and immediately calls itself on the tail. Notice at this</span>
<span class="token comment">// point, we've decided we don't need the first element, and we've</span>
<span class="token comment">// thrown it away, without executing `toList` yet!</span>
<span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Now we start over. Substituting `cons` for `Stream` isn't particularly</span>
<span class="token comment">// interesting, so we'll stop showing it as a separate step from now on.</span>
<span class="token comment">// Apply `map` to the new head.</span>
<span class="token function">cons</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Now when `filter` obtains the head, it passes the predicate, so it</span>
<span class="token comment">// returns a structure with a recursive call, rather than just the</span>
<span class="token comment">// tail.</span>
<span class="token function">cons</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// This is a slightly stylized substitution of the `toList()` call</span>
<span class="token function">List</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// Now we're starting over again, but this as part of a recursive call</span>
<span class="token comment">// inside `toList`. Apply `map` to the third element.</span>
<span class="token function">List</span><span class="token punctuation">(</span>
    <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token function">cons</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// Filter discards this element, too.</span>
<span class="token function">List</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// Apply `map` to the last element</span>
<span class="token function">List</span><span class="token punctuation">(</span>
    <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token function">cons</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// Apply `filter` to the last element</span>
<span class="token function">List</span><span class="token punctuation">(</span>
    <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token function">cons</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// Apply `toList` to the last element</span>
<span class="token function">List</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// `map` and `filter` have no more work to do. The empty stream</span>
<span class="token comment">// becomes the empty `list`, as per `toList`.</span>
<span class="token function">List</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>Notice how the executions of <code>map</code> and <code>filter</code> alternate, and how no intermediate stream is ever fully instantiated.
The effect is the same as if we'd written a custom loop. We managed to compose an efficient computation from a few
simple combinators. We can do so in many more interesting ways, without having to worry about doing more processing than
necessary. As a simple example, we can write <code>find</code>, which returns the first matching element from a stream, in way that
terminates early while re-using <code>filter</code>:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">headOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="infinite-streams-and-corecursion"><a href="#infinite-streams-and-corecursion" aria-hidden="true" class="header-anchor">#</a> Infinite streams and corecursion</h2> <p>As we said earlier, these functions are incremental, so they can work for <em>infinite streams</em>, like this one:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> ones<span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">cons</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ones<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The functions we've written so far only inspect the portion of the stream necessary to perform the requested
computation, so we can use them to operate on infinite streams like <code>ones</code> without fear of initiating an execution that
never ends. For example:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token operator">&gt;</span> ones<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">List</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> ones<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Try playing around with these examples:</p> <ul><li><code>ones.map(x =&gt; x + 1).exists(x =&gt; x % 2 === 0)</code></li> <li><code>ones.takeWhile(x =&gt; x === 1)</code></li> <li><code>ones.forAll(x =&gt; x !=== 1)</code></li></ul> <p>In each of these cases, we get back an answer immediately. Did any of them surprise you? We need to be careful with our
newfound power, however. It's easy to write an expression that never terminates or isn't stack-safe. For example,
<code>ones.forAll(x =&gt; x === 1)</code> will eventually cause a stack overflow, since it will never find an element that failes the
predicate (i.e. isn't equal to 1) and terminates the recursion.</p> <p>Let's get more familiar with <code>Stream</code> by writing some more functions for it.</p> <h3 id="exercise-5-8-constant"><a href="#exercise-5-8-constant" aria-hidden="true" class="header-anchor">#</a> Exercise 5.8. <code>constant</code></h3> <p>Generalize <code>ones</code> into an infinite stream of any value.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code>constant<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="exercise-5-9-from"><a href="#exercise-5-9-from" aria-hidden="true" class="header-anchor">#</a> Exercise 5.9. <code>from</code></h3> <p>Write a function that generates an infinite stream of integers, starting from the given value <code>n</code>, then <code>n + 1</code>, <code>n + 2</code>, and so on.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">from</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="exercise-5-10-fibs"><a href="#exercise-5-10-fibs" aria-hidden="true" class="header-anchor">#</a> Exercise 5.10. <code>fibs</code></h3> <p>Write the function <code>fibs</code>, which generates an infinite stream of Fibonacci numbers: 0, 1, 1, 2, 3, 5, 8, and so on.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">fibs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="exercise-5-11-unfold"><a href="#exercise-5-11-unfold" aria-hidden="true" class="header-anchor">#</a> Exercise 5.11. <code>unfold</code></h3> <p>Write a more general stream-building function, <code>unfold</code>, which takes an initial state and a function for producing both
the next state and the next value in the generated stream.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code>unfold<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>z<span class="token punctuation">:</span> <span class="token constant">S</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Option<span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">S</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Stream<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/13/2019, 1:52:12 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/fp_book_club_ts/chapter_4.html" class="prev">
          Chapter 4. Handling errors without exceptions
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/fp_book_club_ts/assets/js/8.ac5b33ff.js" defer></script><script src="/fp_book_club_ts/assets/js/app.9c1fe345.js" defer></script>
  </body>
</html>
