<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chapter 4. Handling errors without exceptions | Functional Programming in TypeScript</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/fp_book_club_ts/assets/css/0.styles.2e0fd9ce.css" as="style"><link rel="preload" href="/fp_book_club_ts/assets/js/app.ba8d5564.js" as="script"><link rel="preload" href="/fp_book_club_ts/assets/js/2.02fd0292.js" as="script"><link rel="preload" href="/fp_book_club_ts/assets/js/9.31d54afd.js" as="script"><link rel="prefetch" href="/fp_book_club_ts/assets/js/10.c3c08d9c.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/11.3e4fd880.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/12.1ec8026e.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/3.d2883898.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/4.7da4fb13.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/5.599a7ac7.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/6.d708eb58.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/7.eb897770.js"><link rel="prefetch" href="/fp_book_club_ts/assets/js/8.57c5fc43.js">
    <link rel="stylesheet" href="/fp_book_club_ts/assets/css/0.styles.2e0fd9ce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fp_book_club_ts/" class="home-link router-link-active"><!----> <span class="site-name">Functional Programming in TypeScript</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fp_book_club_ts/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Chapters</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_1.html" class="nav-link">Chapter 1</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_2.html" class="nav-link">Chapter 2</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_3.html" class="nav-link">Chapter 3</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_4.html" class="nav-link router-link-exact-active router-link-active">Chapter 4</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_5.html" class="nav-link">Chapter 5</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_6.html" class="nav-link">Chapter 6</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/calebharris/fp_book_club_ts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fp_book_club_ts/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Chapters</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_1.html" class="nav-link">Chapter 1</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_2.html" class="nav-link">Chapter 2</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_3.html" class="nav-link">Chapter 3</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_4.html" class="nav-link router-link-exact-active router-link-active">Chapter 4</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_5.html" class="nav-link">Chapter 5</a></li><li class="dropdown-item"><!----> <a href="/fp_book_club_ts/chapter_6.html" class="nav-link">Chapter 6</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/calebharris/fp_book_club_ts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fp_book_club_ts/chapter_1.html" class="sidebar-link">Chapter 1. What is functional programming?</a></li><li><a href="/fp_book_club_ts/chapter_2.html" class="sidebar-link">Chapter 2. Getting started with functional programming in TypeScript</a></li><li><a href="/fp_book_club_ts/chapter_3.html" class="sidebar-link">Chapter 3. Functional data structures</a></li><li><a href="/fp_book_club_ts/chapter_4.html" class="active sidebar-link">Chapter 4. Handling errors without exceptions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#possible-alternatives-to-exceptions" class="sidebar-link">Possible alternatives to exceptions</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#the-option-data-type" class="sidebar-link">The Option data type</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#usage-patterns-for-option" class="sidebar-link">Usage patterns for Option</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#exercise-4-1-implement-option-functions" class="sidebar-link">Exercise 4.1. Implement Option functions</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#exercise-4-2-implement-variance-in-terms-of-flatmap" class="sidebar-link">Exercise 4.2. Implement variance in terms of flatMap</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#option-composition-lifting-and-wrapping-exception-oriented-apis" class="sidebar-link">Option composition, lifting, and wrapping exception-oriented APIs</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#exercise-4-3-map2" class="sidebar-link">Exercise 4.3. map2</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#converting-exception-based-apis-to-option" class="sidebar-link">Converting exception-based APIs to Option</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#exercise-4-4-sequence" class="sidebar-link">Exercise 4.4. sequence</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#exercise-4-5-traverse" class="sidebar-link">Exercise 4.5. traverse</a></li></ul></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#the-either-data-type" class="sidebar-link">The Either data type</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#converting-exception-based-apis-to-either" class="sidebar-link">Converting exception-based APIs to Either</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#exercise-4-6-basic-functions-on-either" class="sidebar-link">Exercise 4.6. Basic functions on Either</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#exercise-4-7-sequence-and-traverse-for-either" class="sidebar-link">Exercise 4.7. sequence and traverse for Either</a></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#exercise-4-8-error-handling-tactics" class="sidebar-link">Exercise 4.8. Error handling tactics</a></li></ul></li><li class="sidebar-sub-header"><a href="/fp_book_club_ts/chapter_4.html#summary" class="sidebar-link">Summary</a></li></ul></li><li><a href="/fp_book_club_ts/chapter_5.html" class="sidebar-link">Chapter 5. Strictness and laziness</a></li><li><a href="/fp_book_club_ts/chapter_6.html" class="sidebar-link">Chapter 6. Purely functional state</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="chapter-4-handling-errors-without-exceptions"><a href="#chapter-4-handling-errors-without-exceptions" aria-hidden="true" class="header-anchor">#</a> Chapter 4. Handling errors without exceptions</h1> <p>Exceptions, as mentioned in <a href="/fp_book_club_ts/chapter_1.html">Chapter 1</a>, are not a great fit for functional programming for a couple
reasons:</p> <ol><li>They break referential transparency (RT).</li> <li>They are not type-safe: the type of a function says nothing about whether or not it can throw an exception, so the
compiler loses some ability to enforce correctness.</li></ol> <p>Exceptions <em>do</em> have an upside, in that they allow the programmer to consolidate error-handling logic.</p> <p>In this chapter, we'll learn how to use types to encode failures and error conditions, so that we can capture them as
ordinary values. This lets us keep our FP principles intact while maintaining the benefit of error-handling
consolidation.</p> <h2 id="possible-alternatives-to-exceptions"><a href="#possible-alternatives-to-exceptions" aria-hidden="true" class="header-anchor">#</a> Possible alternatives to exceptions</h2> <p>Consider this example, which computes the mean of a list:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> mean <span class="token operator">=</span> <span class="token punctuation">(</span>xs<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter"><span class="token builtin">number</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xs<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;nil&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Attempt to take mean of empty list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">sum</span><span class="token punctuation">(</span>xs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">length</span><span class="token punctuation">(</span>xs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>It's a <em>partial function</em>, which means its result is undefined for some input values. Throwing an exception is one way
of handling these values, but there are others:</p> <p>We could return a special value, like <code>NaN</code> (which is TypeScript for &quot;not a number&quot;) or <code>null</code>, but there are several
drawbacks to this approach.</p> <ul><li>Makes it easy for errors to proliferate due to callers neglecting to check for this special value</li> <li>Creates need for boilerplate error checking code</li> <li>Doesn't work with polymorphic code. For some input types, there may not be an appropriate special value to return</li> <li>Forces a special policy on callers, who can't simply call the function and use the result, which makes it difficult
to compose <code>mean</code> with other functions</li></ul> <p>We could change <code>mean</code>'s API and force the caller to provide the value to return for empty lists, like this:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> mean <span class="token operator">=</span> <span class="token punctuation">(</span>xs<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> onEmpty<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter"><span class="token builtin">number</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xs<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;nil&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> onEmpty<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">sum</span><span class="token punctuation">(</span>xs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">length</span><span class="token punctuation">(</span>xs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>But this requires immediate callers to have knowledge of how to handle the special cases, again making it difficult to
compose the function into a larger computation, and limiting the freedom the caller has to decide how to handle special
cases.</p> <h2 id="the-option-data-type"><a href="#the-option-data-type" aria-hidden="true" class="header-anchor">#</a> The <code>Option</code> data type</h2> <p>A functional solution to this problem is to encode into the function's return type the possibility of not returning a
value. Behold, the <code>Option</code> type!</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">type</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> Some<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">|</span> None<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Some</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> tag<span class="token punctuation">:</span> <span class="token string">&quot;some&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;some&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">readonly</span> value<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">None</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> tag<span class="token punctuation">:</span> <span class="token string">&quot;none&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>Option</code>, like <code>List</code>, has one type parameter, which is the type of value that it might contain. An <code>Option</code> can be
either <code>Some</code>, meaning it definitely has a value, or <code>None</code> meaning the value is not defined.</p> <p>Where as <code>List</code> represents the idea that multiple values of a type may exist, <code>Option</code> represents the idea that a value
may not exist at all. In FP, both of these notions are examples of <em>effects</em> (which are distinct from <em>side effects</em>).
<code>List</code> models the effect of having multiple values; <code>Option</code> models the effect of optionality.</p> <p>We can use <code>Option</code> to rewrite <code>mean</code> as a <em>total function</em>:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> mean <span class="token operator">=</span> <span class="token punctuation">(</span>xs<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xs<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;nil&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">NONE</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>xs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">length</span><span class="token punctuation">(</span>xs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>It now always has a defined result, which is <code>None</code> when the input list is empty.</p> <h3 id="usage-patterns-for-option"><a href="#usage-patterns-for-option" aria-hidden="true" class="header-anchor">#</a> Usage patterns for <code>Option</code></h3> <p><code>Option</code> is convenient because we can factor out common error-handling patterns into higher-order functions, meaning we
can dispense with much of the boilerplate that comes with exception-oriented code.</p> <h4 id="basic-functions-on-option"><a href="#basic-functions-on-option" aria-hidden="true" class="header-anchor">#</a> Basic functions on Option</h4> <p>We're going to use a different style of function definition than we used with <code>List</code>, where we placed all our functions
at the top level of the module and exported each of them. Here, when possible, we'll place the functions &quot;inside&quot; our
<code>Option</code> type, so they can be called with an object-oriented style of syntax (e.g. <code>opt.map(a =&gt; a.toString())</code> instead
of <code>map(opt, a =&gt; a.toString())</code>). In order to accomplish that, we need to introduce a few new bits of TypeScript
syntax. Examine this expanded definition of <code>Option</code>:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">type</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> Some<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">|</span> None<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// 1. `abstract class` defines class that cannot be instantiated</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">OptionBase</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>

  <span class="token comment">// 2. `this` parameter</span>
  map<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

  <span class="token comment">// 3. `extends` keyword introducing type bound</span>
  <span class="token comment">// 4. `() =&gt; U` function type is a &quot;thunk&quot;</span>
  getOrElse<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">onNone</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">U</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">U</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

  <span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">p</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  flatMap<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  orElse<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">ou</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Option<span class="token operator">&lt;</span><span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 5. `extends` keyword creating inheritance relationship</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Some</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">OptionBase</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> tag<span class="token punctuation">:</span> <span class="token string">&quot;some&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;some&quot;</span><span class="token punctuation">;</span>

  <span class="token comment">// 6. classes must call `super()` if they extend other classes</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">readonly</span> value<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">None</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">OptionBase</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 7. `never` is the &quot;bottom type&quot;</span>
  <span class="token comment">// 8. `static` creates &quot;class&quot; property</span>
  <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token constant">NONE</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token builtin">never</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">None</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">readonly</span> tag<span class="token punctuation">:</span> <span class="token string">&quot;none&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">;</span>

  <span class="token comment">// 9. `private` prevents access by external code</span>
  <span class="token keyword">private</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 10. smart constructors for `None` and `Some`</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> none <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> None<span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> some <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="_1-abstract-classes"><a href="#_1-abstract-classes" aria-hidden="true" class="header-anchor">#</a> 1. Abstract classes</h4> <p>As we said, we want to place our functions &quot;inside&quot; the <code>Option</code> type. But, since <code>Option</code> is just a union type
comprising two otherwise unrelated types, how do we accomplish that? Where is the common place to put our functions?
TypeScript provides an <em>abstract class</em> for this purpose, which is a class that cannot be directly instantiated. Rather,
it must be <em>extended</em> by a normal, or <em>concrete</em>, class (more on that later). This is exactly what we're looking for,
since we do not want to add another data constructor to our <code>Option</code> type, but do want the ability to define our
functions once and still have them be usable from both <code>Some</code> and <code>None</code> values. Note that we are not exporting
<code>OptionBase</code> to users of our <code>Option</code> module. As an implementation detail, we want the freedom to change <code>OptionBase</code> as
needed, so it's best to keep it private to the module, to prevent accidental dependencies on a part of our code that's
likely to change.</p> <h4 id="_2-this-parameters"><a href="#_2-this-parameters" aria-hidden="true" class="header-anchor">#</a> 2. <code>This</code> parameters</h4> <p>In many object-oriented languages, defining a method on a class is really a shorthand for defining a function that
takes, as a parameter, an instance of the method's containing class. Inside the method, this undeclared parameter is
often called <code>this</code>. TypeScript is no different. For example, this code fragment...</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">OptionBase</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">filter</span><span class="token punctuation">(</span><span class="token function-variable function">p</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>...is equivalent to this:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">OptionBase</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> OptionBase<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">p</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>As you can see, the implicit <code>this</code> parameter has type <code>OptionBase&lt;A&gt;</code>. Many other object-oriented languages give us no
further control over <code>this</code>. We get a parameter whose type matches that of the enclosing class, and that's that. But
TypeScript allows us to explicitly declare the <code>this</code> parameter and give it an arbitrary type. So the previous snippet
is actually valid TypeScript code.</p> <div class="tip custom-block"><p class="custom-block-title">JavaScript's &quot;this&quot; value</p> <p>TypeScript's mission is to remain a strict superset of JavaScript. Therefore, its type system is uniquely shaped to
provide type information on top of existing JavaScript code. JavaScript is object-oriented, but does not have classes,
and therefore has a number of idiosyncrasies around its treatment of the <code>this</code> value inside functions. One of the most
impactful of these is that <code>this</code> can be dynamically assigned at runtime. For more about JavaScript's <code>this</code> value and
how TypeScript's <code>this</code> parameters address it from a static typing perspective, see <a href="https://yehudakatz.com/2011/08/11/understanding-javascript-function-invocation-and-this/" title="Yehuda Katz - Understanding JavaScript Function Invocation and 'this'" target="_blank" rel="noopener noreferrer">&quot;Understanding JavaScript Function
Invocation and <code>this</code>&quot;<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> by Yehuda Katz and <a href="https://www.typescriptlang.org/docs/handbook/functions.html" title="Functions - TypeScript Handbook" target="_blank" rel="noopener noreferrer">the &quot;Functions&quot; section of the TypeScript Handbook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></div> <p>The reason we need to include a <code>this</code> parameter in the method signatures of our <code>OptionBase</code> is that we want to take
advantage of the compiler help we get when using tagged unions (which we discussed in <a href="/fp_book_club_ts/chapter_3.html#representing-algebraic-data-types-in-typescript" title="Chapter 3 - Functional Programming in TypeScript">Chapter 3</a>). Because
<code>OptionBase</code> is an abstract class, it is open to be extended by other concrete classes beyond our <code>Some</code> and <code>None</code>.
That means the TypeScript compiler can never know all the possible types that can be an <code>OptionBase</code>, which defeats our
tagged union structure. The workaround is to fix the type of <code>this</code> in our methods to <code>Option</code>, which is our tagged
union type and therefore closed to additions. Doing so makes attempting to call our <code>OptionBase</code> methods on anything
other than a <code>Some</code> or <code>None</code> a compile error.</p> <h4 id="_3-type-bounds"><a href="#_3-type-bounds" aria-hidden="true" class="header-anchor">#</a> 3. Type bounds</h4> <p>Our <code>Option</code> module uses the <code>extends</code> keyword in two separate but related ways. The first is in the parameter lists of
<code>getOrElse</code> and <code>orElse</code>. In a type parameter list, the syntax <code>&lt;T extends U, U&gt;</code> declares two type parameters and a
relationship between them in which <code>T</code> must be equal to or a subtype of <code>U</code>. This is known as a <em>type bound</em>,
specifically an <em>upper type bound</em>. The right hand side of the <code>extends</code> keyword need not be another type variable, but
could be a concrete type, as in <code>&lt;T extends string&gt;</code>.</p> <p>So why do we need this? Bear with me, this is a bit of a long explanation. First, we need to talk about <em>variance</em>.
Variance, in this context, refers to how the relationship between types that might be substituted for type parameters
affects the relationship between instances of generic types. Consider the following class hierarchy:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Pet</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Fish</span> <span class="token keyword">extends</span> <span class="token class-name">Pet</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token keyword">extends</span> <span class="token class-name">Pet</span> <span class="token punctuation">{</span>
  breed<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>In this snippet, <code>Fish</code> and <code>Dog</code> are subtypes of <code>Pet</code> (we still haven't explained what <code>extends</code> means when used like
this, but hopefully the meaning is starting to become clear). What does that say about the relationship between
<code>Option&lt;Pet&gt;</code> and <code>Option&lt;Fish&gt;</code>? Well, that depends on the <em>variance</em> of <code>Option</code>. There are three possibilities,
called <em>covariance</em>, <em>contravariance</em>, and <em>invariance</em>:</p> <ul><li>If <code>Option&lt;Fish&gt;</code> is a subtype of <code>Option&lt;Pet&gt;</code>, we say that <code>Option</code> is <em>covariant</em>.</li> <li>If <code>Option&lt;Fish&gt;</code> is a supertype of <code>Option&lt;Pet&gt;</code> (i.e. the relationship is reversed), we say that <code>Option</code> is
<em>contravariant</em>.</li> <li>If <code>Option&lt;Fish&gt;</code> is neither a subtype nor a supertype of <code>Option&lt;Pet&gt;</code> (i.e. there is no relationship and one cannot
be used where the other is expected), we say that <code>Option</code> is <em>invariant</em>.</li></ul> <p>In TypeScript, generic classes are covariant: an instance of <code>Option&lt;Fish&gt;</code> can be used wherever an <code>Option&lt;Pet&gt;</code> is
expected. Functions are bit more complicated: they are covariant in their return type, but contravariant in their
argument types. To understand why, consider the <code>map</code> function of <code>Option</code>. It expects a function that takes a parameter
of type <code>A</code> and returns a value of type <code>B</code>. Let's assume that <code>A</code> and <code>B</code> have been resolved to <code>Pet</code> and <code>string</code>,
respectively. The code below is simplified and does not include a <code>this</code> parameter, which doesn't impact this
discussion:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code>map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> Pet</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>It's clear that the <code>f</code> we pass to <code>map</code> can return a <code>string</code> or any subtype of <code>string</code>, since the calling code can
deal with the result as though it were a <code>string</code> without caring about its finer-grained type. But <code>f</code> must be able to
accept a <code>Pet</code> value. If we attempt to pass a function that requires something more specific, like a <code>Dog</code>, we might run
into trouble. Our function might, for example, try to access the <code>breed</code> property, which isn't guaranteed to exist for
all <code>Pet</code>s. Thus, the only way to ensure type safety is to require <code>f</code> to accept a <code>Pet</code> <em>or any supertype of</em> <code>Pet</code>,
demonstrating that functions are contravariant in their argument types.</p> <p>OK, we're almost there. We know what variance is, and we know what type bounds are. So what does this have to do with
<code>orElse</code> and <code>getOrElse</code>? Let's look again at the signature of <code>getOrElse</code>.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code>getOrElse<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">onEmpty</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">U</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">U</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Recall that <code>OptionBase</code> has one type parameter, <code>A</code>. But why doesn't <code>A</code> show up in <code>getOrElse</code>? Well, it's all
<code>None</code>'s fault. <code>None</code> extends <code>OptionBase&lt;never&gt;</code>. We haven't talked about this yet, but <code>never</code> is the so-called
<em>bottom type</em> in TypeScript, representing the type of expressions that either are never evaluated or never return. It's
called the bottom type because it is a subtype of every other type. One of the rules of <code>never</code> is that values of type
<code>never</code> are only assignable to variables of type <code>never</code>.</p> <p>Remember <code>mean</code>? It results in an <code>Option&lt;number&gt;</code>, which could be either a <code>Some&lt;number&gt;</code> or a <code>None</code>. Say we want to
execute this snippet:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> vals <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> avg<span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span>vals<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Now, imagine that <code>getOrElse</code> didn't have any fancy extra type parameters, instead just using the base type's <code>A</code>
parameter, like so:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">onEmpty</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">A</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>If <code>vals</code> in the above fragment contained a non-empty list, <code>mean</code> would return a <code>Some&lt;number&gt;</code>, and <code>getOrElse</code> would
return the contained number. But, if <code>vals</code> were an empty list, then we'd end up with a <code>None</code>, and <code>getOrElse</code> would
return a value of type <code>never</code>. By the rule of <code>never</code> we discussed earlier, we cannot assign a <code>never</code> value to
variable of type <code>number</code>, and we end up with a compile error. We need a way to specify that <code>getOrElse</code> returns a
supertype of <code>A</code>. Since everything is a supertype of <code>never</code>, this would work for the <code>None</code> case. In other words, we
need to specify a new type parameter whose <em>lower bound</em> is <code>A</code>.</p> <p>TypeScript does not have direct syntax for defining lower bounds, but it is possible to do so when we can express the
lower bound as an inverted upper bound. Look back at the real <code>getOrElse</code>. The type parameter list, <code>&lt;T extends U, U&gt;</code>,
establishes <code>U</code> as the upper bound of <code>T</code>. We can also say that <code>T</code> is the lower bound of <code>U</code>. Now, we just need to
relate <code>A</code> to <code>T</code> and <code>U</code> somehow. The <code>this</code> parameter, <code>this: Option&lt;T&gt;</code>, effectively makes <code>T</code> an alias of <code>A</code>.
Voila! We have established <code>A</code> as the lower bound of <code>U</code>.</p> <p>Returning to our example snippet, if <code>mean</code> returns <code>None</code>, then <code>A</code> is resolved to <code>never</code>, but <code>U</code> in <code>getOrElse</code> is
resolved to <code>number</code> because of the function we pass in to provide the default value: <code>() =&gt; -1</code>. This works because
<code>number</code> is a supertype of <code>never</code>. That means the whole expression returns a value of type <code>number</code>, and we have
restored type safety!</p> <p>Whew! That took a while. Don't worry if this stuff about variance isn't immediately clear to you. As long as you can
follow the types in the given function signatures, you'll still be able to understand this chapter and complete the
exercises. Also, check out the <a href="https://github.com/fpinscala/fpinscala/wiki/Chapter-4:-Handling-errors-without-exceptions#variance-in-optiona" title="fpinscala Wiki" target="_blank" rel="noopener noreferrer">online notes about variance<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for <em>Functional Programming in Scala</em>.</p> <h4 id="_4-thunks"><a href="#_4-thunks" aria-hidden="true" class="header-anchor">#</a> 4. Thunks</h4> <p>It would be advantageous if the default values provided to <code>getOrElse</code> and <code>orElse</code> were not evaluated unless they had
to be. In other words, we'd like them to be <em>lazily evaluated</em>. TypeScript does not provide an explicit mechanism for
lazy evaluation (we'll talk more about this in <a href="/fp_book_club_ts/chapter_5.html">Chapter 5</a>). But, a common technique in FP to achieve the
effect of lazy evaluation is to accept, instead of a value, a function that returns a value of the needed type. Such a
function is called a <em>thunk</em>, and you'll see them often throughout these notes.</p> <h4 id="_5-inheritance"><a href="#_5-inheritance" aria-hidden="true" class="header-anchor">#</a> 5. Inheritance</h4> <p>Finally, we come to the use of <code>extends</code> in the definition of the <code>Some</code> and <code>None</code> classes, which both extend
<code>OptionBase</code>. This sets up an inheritance relationship, meaning that <code>Some</code> and <code>None</code> <em>inherit</em> methods and properties
defined on <code>OptionBase</code>.</p> <h4 id="_6-super"><a href="#_6-super" aria-hidden="true" class="header-anchor">#</a> 6. super()</h4> <p>We'll try to use class hierarchies sparingly throughout these notes. This is in no small part because defining
inheritance relationships between classes creates a rigid, inflexible linkage and requires some boilerplate code. For
example, classes that extend other classes must call <code>super()</code> if they define a constructor, which invokes the
constructor of the superclass. This ensures that required properties in the superclass have been defined before the
subclass attempts to access them.</p> <h4 id="_7-the-bottom-type"><a href="#_7-the-bottom-type" aria-hidden="true" class="header-anchor">#</a> 7. The bottom type</h4> <p>We've already encountered <code>never</code> in our journey to understand variance. There's not much more to say here, except that
we'll see <code>never</code> used in the future, as it is here, to collapse possibilities. Since <code>None</code> cannot hold a value, it
makes sense for it not to have a type parameter. But, because it extends <code>OptionBase</code>, it must either declare a type
parameter and &quot;pass it on&quot; to <code>OptionBase</code>, or extend <code>OptionBase</code> with a specific type. Our final solution is a bit of
a compromise. We give the class <code>None</code> a type parameter and then declare a constant, <code>NONE</code>, of type <code>Option&lt;never&gt;</code>.
Whenever we return a <code>None</code>, we'll return this value. The type parameter on <code>None</code> is necessary for the compiler to
understand, in some cases, that the <code>OptionBase</code> methods are compatible with both <code>Some</code> and <code>None</code>.</p> <h4 id="_8-static-properties"><a href="#_8-static-properties" aria-hidden="true" class="header-anchor">#</a> 8. <code>static</code> properties</h4> <p>A property marked <code>static</code> has a different lifetime than the other properties (a.k.a. <em>instance properties</em>) of a class.
It has the same lifetime as the class definition itself. In other words, all instances of <code>None</code> share the same value
for their <code>NONE</code> property. The <code>None.NONE</code> property is an implementation of the <a href="https://en.wikipedia.org/wiki/Singleton_pattern" title="Singleton pattern - Wikipedia" target="_blank" rel="noopener noreferrer">singleton pattern<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> of
object-oriented programming.</p> <h4 id="_9-private-properties-and-methods"><a href="#_9-private-properties-and-methods" aria-hidden="true" class="header-anchor">#</a> 9. <code>private</code> properties and methods</h4> <p>A property or method of a class marked as <code>private</code> can only be accessed by code within the same class. We want to
expose just one value of type <code>None</code> to clients of our <code>Option</code> module, in part as an optimization. To get the compiler
to help us enforce this constraint, we mark the constructor of <code>None</code> as <code>private</code>, making it difficult for clients to
create new <code>None</code> values.</p> <h4 id="_10-smart-constructors"><a href="#_10-smart-constructors" aria-hidden="true" class="header-anchor">#</a> 10. Smart constructors</h4> <p><em>Smart constructors</em> encapsulate the logic of creating new values using our data constructors. As we said, we only want
clients to use our predefined singleton <code>None</code> value, rather than creating their own. To make it easier, we offer this
<code>none()</code> smart constructor, which simply returns the singleton. By convention, the names of smart constructors typically
mirror those of their corresponding data constructors, but with lowercase initial letters. It's easier to tell clients
to just use the function to get <code>None</code> values, rather than having them always use the <code>None.NONE</code> reference. For the
sake of symmetry, and allowing clients to omit a number of <code>new</code> invocations, we also provide a <code>some()</code> smart
constructor. Using these functions, which are annotated with a return type of <code>Option&lt;A&gt;</code>, also helps the compiler make
better type inferences.</p> <h3 id="exercise-4-1-implement-option-functions"><a href="#exercise-4-1-implement-option-functions" aria-hidden="true" class="header-anchor">#</a> Exercise 4.1. Implement <code>Option</code> functions</h3> <p>Implement the five functions declared on <code>OptionBase</code>: <code>map</code>, <code>getOrElse</code>, <code>filter</code>, <code>flatMap</code>, and <code>orElse</code>.</p> <ul><li>It's fine to use our pattern-matching approximation and directly examine whether <code>this</code> is <code>Some</code> or <code>None</code>, but you
should really only need to do that in <code>map</code> and <code>getOrElse</code>. All the other functions should be expressible in terms of
<code>map</code>, <code>getOrElse</code>, and each other.</li> <li>The type signatures of <code>map</code> and <code>flatMap</code> should be enough to guide their implementation.</li> <li><code>getOrElse</code> returns the contained value of a <code>Some</code>, or the value returned by the thunk in case of a <code>None</code>.</li> <li><code>orElse</code> is similar to <code>getOrElse</code>, but the return type of the thunk, and of itself, is <code>Option</code>.</li></ul> <details><summary>Answer</summary> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">OptionBase</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>

  <span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">p</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">some</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  flatMap<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  getOrElse<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">onEmpty</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">U</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">U</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">onEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  map<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">some</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  orElse<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">ou</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Option<span class="token operator">&lt;</span><span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">U</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=&gt;</span> <span class="token function">some</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">ou</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></details> <h4 id="when-to-use-the-basic-option-functions"><a href="#when-to-use-the-basic-option-functions" aria-hidden="true" class="header-anchor">#</a> When to use the basic Option functions</h4> <p>When working with <code>Option</code> values, we can always explicity test for <code>Some</code> vs. <code>None</code> and act accordingly. But usually,
we'll use the higher-order functions you implemented in the first exercise of this chapter. These allow us to build up
complex executions using <code>Option</code>s without having to sprinkle our code with <code>if</code>-checks, and defer error-handling to the
end.</p> <p>Let's look at a few examples, using the following snippet of a human resources application:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Employee</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  department<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  manager<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Employee<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> lookupByName <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Employee<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>To look up an employee named Joe, and if he exists, get his department, we could write:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">let</span> joeDept<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> joe <span class="token operator">=</span> <span class="token function">lookupByName</span><span class="token punctuation">(</span><span class="token string">&quot;Joe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>joe<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;some&quot;</span><span class="token punctuation">)</span>
  joeDept <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>joe<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">else</span>
  joeDept <span class="token operator">=</span> <span class="token constant">NONE</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>But this is exactly what <code>map</code> does for us. It's much simpler to write:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> joeDept <span class="token operator">=</span> <span class="token function">lookupByName</span><span class="token punctuation">(</span><span class="token string">&quot;Joe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">emp</span> <span class="token operator">=&gt;</span> emp<span class="token punctuation">.</span>department<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>We achieve the same result: <code>joeDept</code> is a <code>Some&lt;string&gt;</code> if Joe exists, and a <code>None</code> if not. The code to extract Joe's
department only runs in the <code>Some</code> case. Note that we also did away with the need for intermediate mutable state. Here
are some other ways we can compose these functions together:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// `Some(manager)` if Joe exists and has a manager</span>
<span class="token comment">// `None` if Joe doesn't exist or doesn't have a manager</span>
<span class="token function">lookupByName</span><span class="token punctuation">(</span><span class="token string">&quot;Joe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token parameter">emp</span> <span class="token operator">=&gt;</span> emp<span class="token punctuation">.</span>manager<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Joe's department if he exists</span>
<span class="token comment">// &quot;Default Dept.&quot; if not</span>
<span class="token function">lookupByName</span><span class="token punctuation">(</span><span class="token string">&quot;Joe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">emp</span> <span class="token operator">=&gt;</span> emp<span class="token punctuation">.</span>department<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token string">&quot;Default Dept.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="exercise-4-2-implement-variance-in-terms-of-flatmap"><a href="#exercise-4-2-implement-variance-in-terms-of-flatmap" aria-hidden="true" class="header-anchor">#</a> Exercise 4.2. Implement <code>variance</code> in terms of <code>flatMap</code></h3> <p>Implement a <code>variance</code> function using Option's <code>flatMap</code>. The variance of a set of numbers is the average of the square
of each element's distance from the set's mean. You can use the formula <code>Math.pow(x - m, 2)</code> for each element <code>x</code> in the
list to calculate the distance, where <code>m</code> is the mean of the list.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> variance <span class="token operator">=</span> <span class="token punctuation">(</span>xs<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><details><summary>Answer</summary> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> variance <span class="token operator">=</span> <span class="token punctuation">(</span>xs<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span>
  <span class="token function">mean</span><span class="token punctuation">(</span>xs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>
    <span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>xs<span class="token punctuation">,</span> <span class="token parameter">x</span> <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>x <span class="token operator">-</span> m<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></details> <p>With <code>flatMap</code>, we can build up a computation with multiple stages that will abort as soon as the first failure is
encountered. We can inject <code>filter</code> stages to convert successes to failures if any intermediate results don't meet a
particular expectation. These kind of transformation of an <code>Option</code> using <code>map</code>, <code>flatMap</code>, and <code>filter</code>, with
<code>getOrElse</code> doing error-handling at the end, is a common pattern in FP.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> dept<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token function">lookupByName</span><span class="token punctuation">(</span><span class="token string">&quot;Joe&quot;</span><span class="token punctuation">)</span>
                       <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">emp</span> <span class="token operator">=&gt;</span> emp<span class="token punctuation">.</span>department<span class="token punctuation">)</span>
                       <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">dept</span> <span class="token operator">=&gt;</span> dept <span class="token operator">!=</span> <span class="token string">&quot;Accounting&quot;</span><span class="token punctuation">)</span>
                       <span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token string">&quot;Default Dept.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>Option</code> gives us convenient transformations, consolidation of error-handling, <em>and</em> an added layer of protection from
mistakes. The compiler will not let us forget to handle the possibility of <code>None</code>.</p> <h3 id="option-composition-lifting-and-wrapping-exception-oriented-apis"><a href="#option-composition-lifting-and-wrapping-exception-oriented-apis" aria-hidden="true" class="header-anchor">#</a> Option composition, lifting, and wrapping exception-oriented APIs</h3> <p>Although it may seem like <code>Option</code> could end up infecting our entire code base, that does not happen in practice due to
our ability to convert easily functions that deal with plain values into functions that operate on <code>Option</code>. When we
convert a function this way, we say that we've <em>lifted</em> the function into the <em>context</em> of <code>Option</code>. We could just as
easily lift a function into <code>List</code>, or any of the data types we'll explore later in the book.</p> <p>We already have the ability to lift a function of one argument using <code>map</code>:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> lift <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">o<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span>
  <span class="token parameter">o</span> <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>We can use <code>lift</code> on any function we happen to have lying around to make it compatible with <code>Option</code>. For example:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> absOpt <span class="token operator">=</span> <span class="token function">lift</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>We didn't have to rewrite <code>Math.abs</code>; we were able to just lift it into the <code>Option</code> context <em>ex post facto</em>. We can do
this for any function. For example, suppose we're setting up a website for a car insurance company, which includes a
form that users can fill out and submit for an instant rate quote. We'll need to parse the data from the form and call a
function to calculate the rate:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> quoteRate <span class="token operator">=</span> <span class="token punctuation">(</span>age<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> numSpeedingTickets<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter"><span class="token builtin">number</span></span> <span class="token operator">=&gt;</span> <span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Our function takes two numeric arguments, but we'll only have access to the form data as string values. That means we'll
need to parse the string data into numbers, which isn't guaranteed to succeed. The user might, for example, enter
something like &quot;None of your business&quot; as their age.</p> <p>Given a <code>string</code>, we can attempt to parse it into an integer number with the function <code>parseInt</code>. If the <code>string</code> does
not represent a valid integer, <code>parseInt</code> returns the special value <code>NaN</code> (short for <em>not a number</em>). You may recall
that returning special values to encode failures puts some undue burden on a function's caller. It would be nice to
convert <code>parseInt</code> into an <code>Option</code>-based API, which turns out to be fairly easy:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> parseIntOpt <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> i <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token function">some</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Now we have a convenient way to parse form data into <code>Option</code> values. But our <code>quoteRate</code> function takes two raw
numbers. How can we lift <code>quoteRate</code>, a function with two parameters, into <code>Option</code>?</p> <h3 id="exercise-4-3-map2"><a href="#exercise-4-3-map2" aria-hidden="true" class="header-anchor">#</a> Exercise 4.3. <code>map2</code></h3> <p>Write a function, <code>map2</code>, that combines two <code>Option</code>-wrapped values using a provided function. Only when both input
<code>Option</code>s are <code>Some</code> should <code>map2</code> produce a <code>Some</code>. Otherwise, it should return <code>None</code>. Since the syntax
<code>optionC = optionA.map2(optionB, f)</code> feels a little off, let's put <code>map2</code> at the top level of our module, rather than
inside <code>OptionBase</code>. That leaves us with a more natural-feeling <code>optionC = map2(optionA, optionB, f)</code>.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> map2 <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>oa<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
                       ob<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
                       <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token constant">B</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><details><summary>Answer</summary> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> map2 <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>oa<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
                              ob<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
                              <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token constant">B</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span>
  oa<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=&gt;</span> ob<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">b</span> <span class="token operator">=&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></details> <p>Now we can use <code>map2</code> to lift <code>quoteRate</code>:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> parseAndQuoteRate <span class="token operator">=</span>
    <span class="token punctuation">(</span>age<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> numSpeedingTickets<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span>
  <span class="token function">map2</span><span class="token punctuation">(</span>
      <span class="token function">parseIntOpt</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">parseIntOpt</span><span class="token punctuation">(</span>numSpeedingTickets<span class="token punctuation">)</span><span class="token punctuation">,</span>
      quoteRate<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>With <code>map2</code>, we never have to modify an existing function of two arguments to make them &quot;<code>Option</code>-aware&quot;. As a bonus,
try using <code>map2</code> to implement <code>lift2</code>. Can you see how to implement <code>map3</code>, <code>map4</code>, <code>lift3</code>, <code>lift4</code>, etc.?</p> <h3 id="converting-exception-based-apis-to-option"><a href="#converting-exception-based-apis-to-option" aria-hidden="true" class="header-anchor">#</a> Converting exception-based APIs to <code>Option</code></h3> <p>There are a number of JavaScript APIs that throw exceptions, rather than returning special values like <code>parseInt</code>.  For
example, the built-in <code>decodeURI</code> function throws a <code>URIError</code> if its argument is not a well-formed URI.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token parameter">uri<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">string</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>We can write a general-purpose function to wrap these exception-throwing APIs inside <code>Option</code>-returning equivalents:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> Try <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">some</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">tryEncodeURI</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Try</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="exercise-4-4-sequence"><a href="#exercise-4-4-sequence" aria-hidden="true" class="header-anchor">#</a> Exercise 4.4. <code>sequence</code></h3> <p>Write a function named <code>sequence</code> that combines a list of <code>Options</code> into a single <code>Option</code> containing a list of all the
<code>Some</code>-wrapped values in the original list. If any of the original <code>Options</code> was a <code>None</code>, the function should return
<code>None</code>. Otherwise, it should return a <code>Some</code> of a list of values. Once again, we should define this at the top level of
the <code>Option</code> module. You could argue that it belongs in the <code>List</code> module, but there is actually a more abstract data
type we'll introduce later that'll make a good home for <code>sequence</code>.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> sequence <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> List<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><details><summary>Answer</summary> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> sequence <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>ls<span class="token punctuation">:</span> List<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ls<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;nil&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token function">foldRight</span><span class="token punctuation">(</span>
      ls<span class="token punctuation">,</span>
      <span class="token function">some</span><span class="token punctuation">(</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">oa<span class="token punctuation">,</span> ol</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">map2</span><span class="token punctuation">(</span>ol<span class="token punctuation">,</span> oa<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">la<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> la<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></details> <p>Sometimes, we'll want to first apply a function that might fail to a list of simple values, and then <code>sequence</code> over the
resulting list of <code>Option</code>s. For example, we might want to attempt to parse a list of integers out of a list of strings.
To accomplish this, we could first <code>map</code> over the list and then call <code>sequence</code>:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> parseInts <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span>
  <span class="token function">sequence</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> parseIntOpt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>But this is inefficient, because we loop over the list twice: once to apply <code>parseIntOpt</code>, and once to <code>sequence</code> the
result into a single <code>Option</code>. This is a fairly common thing to want to do, so let's create a more optimized function to
accomplish it.</p> <h3 id="exercise-4-5-traverse"><a href="#exercise-4-5-traverse" aria-hidden="true" class="header-anchor">#</a> Exercise 4.5. <code>traverse</code></h3> <p>Write the <code>traverse</code> function, which <code>sequences</code> a list of values, applying a mapping function to each value in-line.
It's easy to write this function in terms of <code>map</code> and <code>sequence</code>, but the whole point of the exercise is to find a more
efficient implementaiton. To test yourself, implement <code>sequence</code> in terms of <code>traverse</code>.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
                        <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><details><summary>Answer</summary> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>ls<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
                        <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Option<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ls<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;nil&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token function">foldRight</span><span class="token punctuation">(</span>
      ls<span class="token punctuation">,</span>
      <span class="token function">some</span><span class="token punctuation">(</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> ol</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">map2</span><span class="token punctuation">(</span>ol<span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">la<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> la<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sequence <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>ls<span class="token punctuation">:</span> List<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span> <span class="token function">traverse</span><span class="token punctuation">(</span>ls<span class="token punctuation">,</span> <span class="token parameter">oa</span> <span class="token operator">=&gt;</span> oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></details> <h2 id="the-either-data-type"><a href="#the-either-data-type" aria-hidden="true" class="header-anchor">#</a> The <code>Either</code> data type</h2> <p><code>Option</code> is cool, but using it for representing error conditions is problematic because it throws away information about
the error. We get either a success in the form of a <code>Some(value)</code> — or nothing. Let's explore a small elaboration on
<code>Option</code>: the <code>Either</code> type, which will let us track the reason for an error.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">type</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> Left<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">|</span> Right<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">EitherBase</span><span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// When mapping over the right side, the left type parameter must be</span>
  <span class="token comment">// promoted to a supertype to satisfy the covariance imposed by TypeScript</span>
  flatMap<span class="token operator">&lt;</span><span class="token constant">F</span> <span class="token keyword">extends</span> <span class="token class-name">G</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">F</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Either<span class="token operator">&lt;</span><span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

  map<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

  <span class="token comment">// Similarly for orElse</span>
  orElse<span class="token operator">&lt;</span><span class="token constant">F</span> <span class="token keyword">extends</span> <span class="token class-name">G</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">F</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">b</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Either<span class="token operator">&lt;</span><span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Left</span><span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">EitherBase</span><span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> tag<span class="token punctuation">:</span> <span class="token string">&quot;left&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">readonly</span> value<span class="token punctuation">:</span> <span class="token constant">E</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Right</span><span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">EitherBase</span><span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> tag<span class="token punctuation">:</span> <span class="token string">&quot;right&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">readonly</span> value<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> left <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>val<span class="token punctuation">:</span> <span class="token constant">E</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Left</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> right <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>val<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Right</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> map2 <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">EE</span> <span class="token keyword">extends</span> <span class="token class-name">E</span><span class="token punctuation">,</span> <span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    a<span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">EE</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token constant">B</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">EE</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>Just like <code>Option</code>, <code>Either</code> has two cases. Unlike <code>Option</code>, both cases of <code>Either</code> hold a value. By tradition, when
<code>Either</code> is used to capture error information, <code>Left</code> signifies an error and <code>Right</code> a successful result. For this
reason, we've chosen <code>E</code> as our left type parameter, to suggest the word &quot;error&quot;. However, <code>Either</code> is not limited to
representing success or failure, and in fact is broadly useful, for there are many situations in which our computations
can return one of two type.</p> <p>Because we're choosing to have our <code>Right</code> data constructor represent success, we'll want functions like <code>map</code> and
<code>flatMap</code> to operate only on <code>Right</code>, and ignore <code>Left</code>. This leaves us with a <em>right-biased</em> <code>Either</code>.</p> <p>Here's <code>mean</code> again, this time returning a <code>Left</code> containing a string represention of the error when the provided list
is empty:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> mean <span class="token operator">=</span> <span class="token punctuation">(</span>xs<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>xs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">left</span><span class="token punctuation">(</span><span class="token string">&quot;mean of empty list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>xs<span class="token punctuation">)</span> <span class="token operator">/</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="converting-exception-based-apis-to-either"><a href="#converting-exception-based-apis-to-either" aria-hidden="true" class="header-anchor">#</a> Converting exception-based APIs to <code>Either</code></h3> <p>Just like we did for <code>Option</code>, we can wrap an exception-throwing function in an <code>Either</code> by returning the thrown
exception as a <code>Left</code>. We need to do a little extra work, because in JavaScript, you can throw anything, not just an
<code>Error</code>.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> Try <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span>Error<span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">left</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token keyword">return</span> <span class="token function">left</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">tryDecodeURI</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Try</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="exercise-4-6-basic-functions-on-either"><a href="#exercise-4-6-basic-functions-on-either" aria-hidden="true" class="header-anchor">#</a> Exercise 4.6. Basic functions on <code>Either</code></h3> <p>Implement versions of <code>map</code>, <code>flatMap</code>, and <code>orElse</code> on <code>Either</code> that operate on the right side only. Also implement
<code>map2</code> as a top-level function in the <code>either</code> module.</p> <details><summary>Answer</summary> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">EitherBase</span><span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  flatMap<span class="token operator">&lt;</span><span class="token constant">F</span> <span class="token keyword">extends</span> <span class="token class-name">G</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">F</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Either<span class="token operator">&lt;</span><span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">left</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  map<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=&gt;</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  orElse<span class="token operator">&lt;</span><span class="token constant">F</span> <span class="token keyword">extends</span> <span class="token class-name">G</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">F</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">b</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Either<span class="token operator">&lt;</span><span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> map2 <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    e1<span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    e2<span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token constant">B</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span>
  e1<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=&gt;</span> e2<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">b</span> <span class="token operator">=&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div></details> <h3 id="exercise-4-7-sequence-and-traverse-for-either"><a href="#exercise-4-7-sequence-and-traverse-for-either" aria-hidden="true" class="header-anchor">#</a> Exercise 4.7. <code>sequence</code> and <code>traverse</code> for <code>Either</code></h3> <p>Implement <code>sequence</code> and <code>traverse</code> for <code>Either</code>. Both functions should return with the first <code>Left</code> they encounter
while processing the input list, or a <code>Right</code> containing a list of values if they do not encounter a <code>Left</code>.</p> <details><summary>Answer</summary> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> sequence <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>le<span class="token punctuation">:</span> List<span class="token operator">&lt;</span>Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> List<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span>
  <span class="token function">traverse</span><span class="token punctuation">(</span>le<span class="token punctuation">,</span> <span class="token parameter">ea</span> <span class="token operator">=&gt;</span> ea<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>aa<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
                           <span class="token function-variable function">f</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> List<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span>
  aa<span class="token punctuation">.</span><span class="token function">foldRight</span><span class="token punctuation">(</span><span class="token function">right</span><span class="token punctuation">(</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> elb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">map2</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> elb<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">b<span class="token punctuation">,</span> lb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">cons</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> lb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></details> <p>Here's an example of using <code>map2</code> to conditionally construct a compound object, <code>Person</code>. The <code>mkPerson</code> function
validates each of its inputs before creating and returning a <code>Person</code>.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Either<span class="token punctuation">,</span> left<span class="token punctuation">,</span> map2<span class="token punctuation">,</span> right <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../error_handling/either&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">readonly</span> name<span class="token punctuation">:</span> Name<span class="token punctuation">,</span> <span class="token keyword">readonly</span> age<span class="token punctuation">:</span> Age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Name</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">readonly</span> name<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Age</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">readonly</span> age<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span>  <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> mkName <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Name<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">left</span><span class="token punctuation">(</span><span class="token string">&quot;Name is empty.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Name</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mkAge <span class="token operator">=</span> <span class="token punctuation">(</span>age<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Age<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>age <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">left</span><span class="token punctuation">(</span><span class="token string">&quot;Age is out of range.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Age</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mkPerson <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Either<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Person<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span>
  <span class="token function">map2</span><span class="token punctuation">(</span><span class="token function">mkName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mkAge</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="exercise-4-8-error-handling-tactics"><a href="#exercise-4-8-error-handling-tactics" aria-hidden="true" class="header-anchor">#</a> Exercise 4.8. Error handling tactics</h3> <p>In the previous example, <code>mkPerson</code> is only able to return one error, even if both the name and the age arguments are
invalid. What would we need to change in order to report both errors? Do we need to change the implementation of <code>map2</code>,
<code>mkPerson</code>, both? Could we create a new data type that's better suited for this requirement than <code>Either</code>? How would
<code>orElse</code>, <code>sequence</code>, and <code>traverse</code> need to change to work for this new data type?</p> <details><summary>Answer</summary> <p>There are a number of variations on <code>Option</code> and <code>Either</code>. If we want to accumulate multiple errors, a simple approach
is a new data type that lets us keep a list of errors in the data constructor that represents failures:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">type</span> Partial<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> Errors<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">|</span> Success<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Errors</span><span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> tag<span class="token punctuation">:</span> <span class="token string">&quot;errors&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;errors&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">readonly</span> errors<span class="token punctuation">:</span> List<span class="token operator">&lt;</span><span class="token constant">E</span><span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Success</span><span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> tag<span class="token punctuation">:</span> <span class="token string">&quot;success&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">readonly</span> value<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>There is a type very similar to this called <a href="https://github.com/gcanti/fp-ts/blob/master/docs/Validation.md" title="Validation - fp-ts API Documentation" target="_blank" rel="noopener noreferrer"><code>Validation</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> in the fp-ts library. You can implement <code>map</code>,
<code>map2</code>, <code>sequence</code>, and so on for this type in such a way that errors are accumulated when possible (<code>flatMap</code> is unable
to accumulate errors — can you see why?). This idea can even be generalized further — we don't need to
accumulate failing values into a list; we can accumulate values using any user-supplied binary function.  It's also
possible to use <code>Either&lt;List&lt;E&gt;, A&gt;</code> directly to accumulate errors, using different implementations of helper functions
like <code>map2</code> and <code>sequence</code>.</p></details> <h2 id="summary"><a href="#summary" aria-hidden="true" class="header-anchor">#</a> Summary</h2> <p>You should now be more familiar with the pitfalls associated with using exceptions for error handling, and with two of
the purely functional patterns for error handling: <code>Option</code> and <code>Either</code>. These data types are common in FP, but the
bigger takeaway is to think about how to represent errors as ordinary values and use higher-order functions to
consolidate error-handling logic.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">6/19/2019, 10:33:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/fp_book_club_ts/chapter_3.html" class="prev">
          Chapter 3. Functional data structures
        </a></span> <span class="next"><a href="/fp_book_club_ts/chapter_5.html">
          Chapter 5. Strictness and laziness
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/fp_book_club_ts/assets/js/app.ba8d5564.js" defer></script><script src="/fp_book_club_ts/assets/js/2.02fd0292.js" defer></script><script src="/fp_book_club_ts/assets/js/9.31d54afd.js" defer></script>
  </body>
</html>
